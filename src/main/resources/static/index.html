<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - AWS Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles */
        body { font-family: 'Inter', sans-serif; background-color: #eef2f7; }
        
        /* Sidebar Styles */
        .sidebar { transition: all 0.3s ease; background-color: #1e293b; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .sidebar-text, .sidebar.collapsed .logo-text { display: none; }
        .sidebar:not(.collapsed) .tooltip { display: none; }
        .sidebar.collapsed .tooltip {
            display: none; position: absolute; left: 100%; top: 50%;
            transform: translateY(-50%); background: #0f172a; color: white;
            padding: 6px 12px; border-radius: 4px; white-space: nowrap; margin-left: 12px; z-index: 50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .sidebar.collapsed nav a:hover .tooltip { display: block; }
        .sidebar nav a { border-left: 4px solid transparent; transition: background-color 0.2s ease, border-left-color 0.2s ease; }
        .sidebar nav a.active-link { background-color: #334155; border-left-color: #60a5fa; }
        .sidebar nav a:hover:not(.active-link) { background-color: #475569; }

        /* Billing Row Styles */
        .billing-row.expanded .chevron-icon { transform: rotate(90deg); }
        .chevron-icon { transition: transform 0.3s ease; }
        .billing-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; background-color: #f8fafc; }
        .billing-row.expanded .billing-details { max-height: 1200px; }

        /* Main Content Layout */
        .main-content-wrapper { display: flex; flex-direction: column; height: 100vh; }
        .main-header { flex-shrink: 0; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .main-body-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding: 1.5rem; position: relative; }
        .summary-cards-fixed { flex-shrink: 0; margin-bottom: 1.5rem; }
        .account-details-scrollable { flex-grow: 1; overflow-y: auto; min-height: 300px; }

        /* Card Styles */
        .summary-card { border-left-width: 5px; transition: all 0.3s ease; background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .summary-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .total-cost-card { border-left-color: #3b82f6; }
        .top-service-card { border-left-color: #10b981; }
        .active-accounts-card { border-left-color: #8b5cf6; }
        .summary-card .icon-bg { width: 3.5rem; height: 3.5rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: transform 0.3s ease; }
        .summary-card:hover .icon-bg { transform: scale(1.1); }
        .total-cost-card .icon-bg { background-color: #eff6ff; color: #2563eb; }
        .top-service-card .icon-bg { background-color: #f0fdf4; color: #16a34a; }
        .active-accounts-card .icon-bg { background-color: #f5f3ff; color: #7c3aed; }

        /* Skeleton Styles */
        .skeleton-card-bg { background-color: #e5e7eb; border-radius: 0.75rem; }
        .skeleton-line-bg { background-color: #d1d5db; border-radius: 0.25rem; }
        .content-fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { to { opacity: 1; } }
        .billing-row-header:hover { background-color: #f9fafb; }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <div id="sidebar" class="sidebar text-white w-64 flex-shrink-0 flex flex-col">
            <div class="p-4 flex items-center border-b border-gray-700 h-16">
                <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center"> <i class="fas fa-cogs"></i> </div>
                <span class="logo-text ml-3 text-xl font-bold">XamOps</span>
            </div>
            <div class="flex-1 overflow-y-auto py-4">
                <nav>
                    <a href="#" id="billingLink" class="block px-4 py-3 text-white active-link">
                        <div class="flex items-center relative"> <i class="fas fa-file-invoice w-6 text-center"></i> <span class="sidebar-text ml-3">Billing</span> <span class="tooltip">Billing</span> </div>
                    </a>
                    <a href="#" id="kubecutLink" class="block px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white">
                        <div class="flex items-center relative"> <i class="fas fa-box-open w-6 text-center"></i> <span class="sidebar-text ml-3">Kubecut</span> <span class="tooltip">Kubecut</span> </div>
                    </a>
                    <a href="#" id="xampingLink" class="block px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white">
                        <div class="flex items-center relative"> <i class="fas fa-rocket w-6 text-center"></i> <span class="sidebar-text ml-3">Xamping</span> <span class="tooltip">Xamping</span> </div>
                    </a>
                </nav>
            </div>
            <div class="p-4 border-t border-gray-700">
                <button id="toggleSidebar" class="w-full text-gray-300 hover:text-white flex items-center">
                    <i class="fas fa-chevron-left"></i> <span class="sidebar-text ml-3">Collapse</span>
                </button>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col overflow-hidden main-content-wrapper">
            <header class="main-header sticky top-0 z-20">
                <div class="px-6 py-4 flex items-center justify-between h-16">
                    <h1 id="mainHeaderText" class="text-2xl font-semibold text-gray-800">Billing Dashboard</h1>
                    <div class="flex items-center">
                         <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm">AM</div>
                         <span class="ml-2 text-gray-700">Aditya Mehta</span>
                    </div>
                </div>
            </header>
            
            <div class="main-body-area"> 
                <div id="filterAndCardsSection" class="summary-cards-fixed">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">Billing Summary</h2>
                            <p class="text-gray-600 text-sm" id="dashboardSubtitle">Select a month to view costs</p>
                        </div>
                        <div class="flex items-center mt-2 sm:mt-0">
                            <label for="month-picker" class="block text-sm font-medium text-gray-700 mr-2">Month:</label>
                            <input type="month" id="month-picker" class="form-input px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                        </div>
                    </div>
                    <div id="summaryCardsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
                        <div class="rounded-lg shadow p-5 summary-card total-cost-card" id="totalCostCard"></div>
                        <div class="rounded-lg shadow p-5 summary-card top-service-card" id="topServiceCard"></div>
                        <div class="rounded-lg shadow p-5 summary-card active-accounts-card" id="activeAccountsCard"></div>
                    </div>
                </div>
                
                <div class="account-details-scrollable">
                    <div id="loadingSkeleton" class="hidden space-y-4">
                        <div class="animate-pulse">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="h-32 bg-gray-300 rounded-lg skeleton-card-bg"></div>
                                <div class="h-32 bg-gray-300 rounded-lg skeleton-card-bg"></div>
                                <div class="h-32 bg-gray-300 rounded-lg skeleton-card-bg"></div>
                            </div>
                            <div class="h-12 bg-gray-300 rounded-md skeleton-card-bg mb-2"></div>
                            <div class="h-20 bg-gray-200 skeleton-card-bg mb-2"></div>
                            <div class="h-20 bg-gray-200 skeleton-card-bg mb-2"></div>
                            <div class="h-20 bg-gray-200 skeleton-card-bg rounded-md"></div>
                        </div>
                    </div>
                    <div id="errorMessage" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-4"></div>
                    <div id="mainDashboardContent" class="hidden">
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="font-semibold text-gray-800">Account Billing Details</h3>
                            </div>
                            <div id="billingTableContainer" class="divide-y divide-gray-200"></div>
                        </div>
                    </div>
                    <div id="noDataMessage" class="hidden p-6 text-center text-lg text-gray-600 bg-white rounded-lg shadow"></div>
                </div>
                <div id="comingSoonMessage" class="hidden p-6 text-center text-2xl text-gray-700"></div>
                
                <footer class="text-xs text-gray-500 text-right py-3 mt-auto flex-shrink-0"> 
                    Powered by Xammer
                </footer>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const mainDashboardContent = document.getElementById('mainDashboardContent');
        const filterAndCardsSection = document.getElementById('filterAndCardsSection');
        const summaryCardsContainer = document.getElementById('summaryCardsContainer');
        const comingSoonMessage = document.getElementById('comingSoonMessage');
        const noDataMessage = document.getElementById('noDataMessage');
        const mainHeaderText = document.getElementById('mainHeaderText');
        const monthPicker = document.getElementById('month-picker');
        const loadingSkeleton = document.getElementById('loadingSkeleton');
        const errorMessageDiv = document.getElementById('errorMessage');
        const billingTableContainer = document.getElementById('billingTableContainer');
        const dashboardSubtitle = document.getElementById('dashboardSubtitle');

        const API_BASE_URL = '/api/costs'; 
        
        // --- UI Interactivity ---
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            const icon = toggleSidebarBtn.querySelector('i');
            const text = toggleSidebarBtn.querySelector('.sidebar-text');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left'); icon.classList.add('fa-chevron-right');
                if(text) text.textContent = 'Expand';
            } else {
                icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-left');
                if(text) text.textContent = 'Collapse';
            }
        });

        window.toggleBillingRow = function(rowElement) {
            rowElement.classList.toggle('expanded');
        }

        function updateActiveSidebarLink(targetId) {
            document.querySelectorAll('#sidebar nav a').forEach(link => link.classList.remove('active-link'));
            const activeLink = document.getElementById(targetId);
            if (activeLink) activeLink.classList.add('active-link');
        }
        
        function showBillingView(isLoading = false) {
            mainHeaderText.textContent = 'Billing Dashboard';
            filterAndCardsSection.classList.remove('hidden');
            comingSoonMessage.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            noDataMessage.classList.add('hidden');
            updateActiveSidebarLink('billingLink');

            if (isLoading) {
                loadingSkeleton.classList.remove('hidden');
                summaryCardsContainer.classList.add('hidden');
                mainDashboardContent.classList.add('hidden');
            } else {
                // Visibility of summaryCardsContainer and mainDashboardContent
                // will be handled by renderDashboard or error display logic
                loadingSkeleton.classList.add('hidden');
            }
        }

        function showComingSoon(featureName, linkId) {
            mainHeaderText.textContent = featureName;
            filterAndCardsSection.classList.add('hidden');
            summaryCardsContainer.classList.add('hidden');
            mainDashboardContent.classList.add('hidden');
            noDataMessage.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            loadingSkeleton.classList.add('hidden');
            comingSoonMessage.textContent = `${featureName} - Coming Soon!`;
            comingSoonMessage.classList.remove('hidden');
            updateActiveSidebarLink(linkId);
        }

        document.getElementById('billingLink').addEventListener('click', (e) => {
            e.preventDefault();
            showBillingView(true); // Show loading state for billing
            loadInitialData(); 
        });
        document.getElementById('kubecutLink').addEventListener('click', (e) => { e.preventDefault(); showComingSoon('Kubecut', 'kubecutLink'); });
        document.getElementById('xampingLink').addEventListener('click', (e) => { e.preventDefault(); showComingSoon('Xamping', 'xampingLink'); });

        // --- Data Formatting & Calculation ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        
        const findTopService = (accounts) => {
            if (!Array.isArray(accounts) || accounts.length === 0) return { name: 'N/A', cost: 0 };
            const serviceTotals = new Map();
            accounts.forEach(account => {
                if(Array.isArray(account.services)) {
                    account.services.forEach(service => {
                        if (service && typeof service.name === 'string' && typeof service.cost === 'number' && service.cost > 0) {
                             const currentTotal = serviceTotals.get(service.name) || 0;
                             serviceTotals.set(service.name, currentTotal + service.cost);
                        }
                    });
                }
            });
            if (serviceTotals.size === 0) return { name: 'N/A', cost: 0 };
            let topService = { name: 'N/A', cost: -1 };
            for (const [name, cost] of serviceTotals.entries()) {
                if (cost > topService.cost) { topService = { name, cost }; }
            }
            return topService;
        };

        // --- Main Rendering Logic ---
        const renderDashboard = (data) => {
            // Ensure data and its properties exist before trying to use them
            const grandTotal = data?.grandTotal ?? 0;
            const accounts = Array.isArray(data?.accounts) ? data.accounts : [];
            const query = data?.query ?? { start: 'N/A', end: 'N/A', granularity: 'N/A' };

            // Update month picker and subtitle
            if (query.start !== 'N/A') {
                const queryStartDate = new Date(query.start + 'T00:00:00Z'); // Ensure UTC parsing
                const monthYearString = `${queryStartDate.getUTCFullYear()}-${String(queryStartDate.getUTCMonth() + 1).padStart(2, '0')}`;
                if (monthPicker.value !== monthYearString) { // Avoid re-setting if already correct
                     monthPicker.value = monthYearString;
                }
                dashboardSubtitle.textContent = `Showing costs for ${queryStartDate.toLocaleString('default', { month: 'long', year: 'numeric', timeZone: 'UTC' })} (Granularity: ${query.granularity || 'N/A'})`;
            } else {
                dashboardSubtitle.textContent = 'Select a month to view costs';
            }
            
            // Populate Summary Cards
            if (document.getElementById('totalCostCard')) document.getElementById('totalCostCard').innerHTML = `<div class="flex justify-between items-center"><div><p class="text-gray-500 text-sm">Total Cost</p><h3 class="text-3xl font-bold mt-1 total-value">${formatCurrency(grandTotal)}</h3></div><div class="icon-bg"><i class="fas fa-dollar-sign"></i></div></div>`;
            const topService = findTopService(accounts);
            if (document.getElementById('topServiceCard')) document.getElementById('topServiceCard').innerHTML = `<div class="flex justify-between items-center"><div><p class="text-gray-500 text-sm">Top Service</p><h3 class="text-2xl font-semibold mt-1 text-green-600 truncate" title="${topService.name || 'N/A'}">${topService.name || 'N/A'}</h3><p class="text-xl font-bold text-green-600">${formatCurrency(topService.cost)}</p></div><div class="icon-bg"><i class="fas fa-star"></i></div></div>`;
            if (document.getElementById('activeAccountsCard')) document.getElementById('activeAccountsCard').innerHTML = `<div class="flex justify-between items-center"><div><p class="text-gray-500 text-sm">Active Accounts</p><h3 class="text-3xl font-bold mt-1 text-purple-600">${accounts.length}</h3></div><div class="icon-bg"><i class="fas fa-users"></i></div></div>`;
            
            // Clear previous table content
            billingTableContainer.innerHTML = '';
            
            // Show summary cards and main content (table area)
            summaryCardsContainer.classList.remove('hidden');
            mainDashboardContent.classList.remove('hidden');
            // Apply fade-in
            [summaryCardsContainer, mainDashboardContent].forEach(el => {
                el.classList.remove('content-fade-in');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('content-fade-in');
            });


            if (accounts.length > 0) {
                noDataMessage.classList.add('hidden'); // Hide "no data" message if there are accounts
                accounts.forEach(account => {
                    const accountName = account.name || 'Unknown Account';
                    const accountId = account.id || 'N/A';
                    const accountTotalCost = typeof account.totalCost === 'number' ? account.totalCost : 0;
                    const services = Array.isArray(account.services) ? account.services : [];

                    const servicesHtml = services.map(service => {
                        const serviceName = service.name || 'Unknown Service';
                        const serviceCost = typeof service.cost === 'number' ? service.cost : 0;
                        return `<tr class="hover:bg-gray-50 transition-colors duration-150"><td class="px-6 py-3 text-sm text-gray-700">${serviceName}</td><td class="px-6 py-3 text-sm text-gray-600 text-right">${formatCurrency(serviceCost)}</td></tr>`;
                    }).join('');

                    const rowElement = document.createElement('div');
                    rowElement.className = 'billing-row';
                    rowElement.innerHTML = `
                        <div class="billing-row-header px-6 py-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors duration-150" onclick="toggleBillingRow(this.parentElement)">
                            <div class="flex items-center flex-1 min-w-0">
                                <div class="w-10 h-10 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center mr-4 flex-shrink-0"><i class="fas fa-building"></i></div>
                                <div class="min-w-0">
                                    <div class="font-medium text-gray-800 truncate" title="${accountName}">${accountName}</div>
                                    <div class="text-sm text-gray-500">ID: ${accountId}</div>
                                </div>
                            </div>
                            <div class="text-right mx-4">
                                <div class="font-semibold text-lg text-gray-800">${formatCurrency(accountTotalCost)}</div>
                                <div class="text-sm text-gray-500">${services.length} services</div>
                            </div>
                            <div class="text-gray-400 chevron-icon"><i class="fas fa-chevron-right"></i></div>
                        </div>
                        <div class="billing-details bg-gray-50/50">
                            <div class="p-6"><h4 class="font-semibold text-gray-700 mb-2">Service Breakdown</h4><div class="overflow-x-auto border rounded-lg shadow-inner"><table class="min-w-full"><thead class="bg-gray-100"><tr><th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th><th class="px-6 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${servicesHtml}</tbody></table></div></div>
                        </div>`;
                    billingTableContainer.appendChild(rowElement);
                });
            } else {
                // No accounts, show appropriate message
                const today = new Date();
                const firstDayOfSelectedMonth = new Date(Date.UTC(parseInt(query.start.substring(0,4)), parseInt(query.start.substring(5,7)) - 1, 1));
                const firstDayOfCurrentMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));

                if (firstDayOfSelectedMonth >= firstDayOfCurrentMonth && query.granularity === 'DAILY') {
                    noDataMessage.textContent = `Cost data for ${queryStartDate.toLocaleString('default', { month: 'long', year: 'numeric', timeZone: 'UTC' })} is not yet available or is currently zero. Please check back later.`;
                } else {
                    noDataMessage.textContent = `No billing data found for the selected period: ${queryStartDate.toLocaleString('default', { month: 'long', year: 'numeric', timeZone: 'UTC' })}.`;
                }
                noDataMessage.classList.remove('hidden');
                // Summary cards are already visible with $0/N/A/0, table area is mainDashboardContent which is visible but its billingTableContainer is empty.
            }
        }

        const fetchCostData = async (url, isInitialLoad = false) => {
            showBillingView(true); // Show skeleton, hide content areas
            
            try {
                await new Promise(resolve => setTimeout(resolve, 300)); 
                const response = await fetch(url);
                if (!response.ok) { 
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText || response.statusText}`); 
                }
                const data = await response.json();
                
                const validatedData = {
                    grandTotal: (data && typeof data.grandTotal === 'number') ? data.grandTotal : 0,
                    accounts: (data && Array.isArray(data.accounts)) ? data.accounts : [],
                    query: (data && data.query && typeof data.query.start === 'string') ? data.query : 
                           { start: 'N/A', end: 'N/A', granularity: 'N/A' }
                };

                if (data && data.error) { 
                     throw new Error(`API returned an error: ${data.message || data.error}`);
                }
                renderDashboard(validatedData);
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                errorMessageDiv.innerHTML = `<p class="font-bold">Could not load dashboard data.</p><p class="text-sm">${error.message}</p>`;
                errorMessageDiv.classList.remove('hidden');
                summaryCardsContainer.classList.add('hidden'); 
                mainDashboardContent.classList.add('hidden');
                noDataMessage.classList.add('hidden');
            } finally {
                loadingSkeleton.classList.add('hidden');
            }
        }
        
        monthPicker.addEventListener('change', () => {
            const monthValue = monthPicker.value;
            if (!monthValue) { return; } 
            const [year, month] = monthValue.split('-').map(Number);
            const startDate = new Date(Date.UTC(year, month - 1, 1));
            const endDate = new Date(Date.UTC(year, month, 1)); 
            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];
            let granularity = 'MONTHLY';
            const today = new Date();
            const firstDayOfSelectedMonthUTC = Date.UTC(year, month - 1, 1);
            const firstDayOfCurrentMonthUTC = Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1);
            if (firstDayOfSelectedMonthUTC >= firstDayOfCurrentMonthUTC) {
                granularity = 'DAILY';
            }
            const url = `${API_BASE_URL}?start=${startStr}&end=${endStr}&granularity=${granularity}`;
            fetchCostData(url);
        });
        
        const loadInitialData = () => fetchCostData(API_BASE_URL, true);

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize sidebar toggle
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                const icon = toggleSidebarBtn.querySelector('i');
                const text = toggleSidebarBtn.querySelector('.sidebar-text');
                if (sidebar.classList.contains('collapsed')) {
                    icon.classList.remove('fa-chevron-left'); icon.classList.add('fa-chevron-right');
                    if(text) text.textContent = 'Expand';
                } else {
                    icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-left');
                    if(text) text.textContent = 'Collapse';
                }
            });
            document.getElementById('billingLink').addEventListener('click', (e) => { e.preventDefault(); loadInitialData();});
            document.getElementById('kubecutLink').addEventListener('click', (e) => { e.preventDefault(); showComingSoon('Kubecut', 'kubecutLink'); });
            document.getElementById('xampingLink').addEventListener('click', (e) => { e.preventDefault(); showComingSoon('Xamping', 'xampingLink'); });
            
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            monthPicker.value = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;

            showBillingView(true); // Setup initial view state with loading
            loadInitialData();
        });
    </script>
</body>
</html>
